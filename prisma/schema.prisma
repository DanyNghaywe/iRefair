generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

model Sheet {
  name      String    @id
  headers   Json
  keyHeader String
  syncedAt  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  rows      SheetRow[]
}

model SheetRow {
  sheetName String
  key       String
  rowIndex  Int?
  values    Json
  hash      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  sheet Sheet @relation(fields: [sheetName], references: [name], onDelete: Cascade)

  @@id([sheetName, key])
  @@index([sheetName])
  @@index([sheetName, rowIndex])
}

model SheetSyncIssue {
  id            String   @id @default(cuid())
  sheetName     String
  action        Json
  error         String
  attempts      Int      @default(0)
  status        String   @default("failed")
  dedupeKey     String?
  lastAttemptAt DateTime?
  notifiedAt    DateTime?
  resolvedAt    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([sheetName])
  @@index([status])
  @@index([dedupeKey])
}

model ReferrerMobileSession {
  id                    String   @id
  irref                 String
  refreshTokenHash      String
  refreshTokenExpiresAt DateTime
  sessionExpiresAt      DateTime
  userAgent             String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  lastUsedAt            DateTime?
  revokedAt             DateTime?

  @@index([irref])
  @@index([refreshTokenExpiresAt])
  @@index([sessionExpiresAt])
  @@index([revokedAt])
}
